<!-- /*
    products.html (Product Listing Page)
    Displays all available products, with client-side filtering by category and search by name.
    Uses main-layout.html as its base.
*/ -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:with="pageTitle='Our Products'">
<body>
    <div th:replace="~{layout/main-layout :: header}"></div>
    <main th:replace="~{layout/main-layout :: content}">
        <th:block>
            <section class="py-8 bg-[#F5F5DC]" aria-label="Product Listing">
                <div class="container mx-auto px-4">
                    <h1 class="text-4xl font-bold text-center mb-10 text-gray-800">Our Products</h1>
                    <div class="mb-10 p-6 bg-white rounded-xl shadow-lg">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                            <div class="md:col-span-1">
                                <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1">Search by Name:</label>
                                <input type="text" id="searchInput" placeholder="Enter product name..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#F56401] focus:border-[#F56401] transition">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Category:</label>
                                <div id="categoryFilters" class="flex flex-wrap gap-3">
                                    <button data-category="All" class="category-btn bg-[#F56401] text-white py-2 px-5 rounded-lg shadow hover:bg-orange-600 transition">All</button>
                                    <button data-category="Coffee & Tea" class="category-btn bg-gray-200 text-gray-700 py-2 px-5 rounded-lg shadow hover:bg-gray-300 transition">Coffee & Tea</button>
                                    <button data-category="Art & Merch" class="category-btn bg-gray-200 text-gray-700 py-2 px-5 rounded-lg shadow hover:bg-gray-300 transition">Art & Merch</button>
                                    <button data-category="Gift Set" class="category-btn bg-gray-200 text-gray-700 py-2 px-5 rounded-lg shadow hover:bg-gray-300 transition">Gift Set</button>
                                    <button data-category="Voucher" class="category-btn bg-gray-200 text-gray-700 py-2 px-5 rounded-lg shadow hover:bg-gray-300 transition">Voucher</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                        <div th:each="product : ${products}" th:attr="data-category=${product.category.toString().replace('_', ' ')}, data-name=${product.name}" class="product-card bg-white border border-gray-200 rounded-lg p-5 shadow-lg flex flex-col transition-transform transform hover:scale-105" th:classappend="${product.quantity == 0 ? 'opacity-70 bg-gray-100' : ''}">
                            <img th:if="${product.id != null && product.image != null}" th:src="@{'/api/products/' + ${product.id} + '/image'}" alt="Product Image" class="w-full h-56 object-cover rounded-md mb-4"/>
                            <div th:if="${product.id == null || product.image == null}" class="w-full h-56 bg-gray-200 flex items-center justify-center rounded-md mb-4 text-gray-400">
                                <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <h3 th:text="${product.name}" class="text-xl font-semibold text-gray-800 mb-2 truncate" th:title="${product.name}">Product Name</h3>
                            <p th:text="'Price: $' + ${#numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT')}" class="text-gray-700 mb-3">Price: $0.00</p>
                            <p class="text-sm text-gray-600 mb-3">Stock: <span th:text="${product.quantity}">0</span></p>
                            <div th:if="${product.quantity > 0}" class="mt-auto">
                                <button th:attr="data-product-id=${product.id},data-product-name=${product.name},data-product-price=${product.price},data-product-stock=${product.quantity},data-product-image-url=@{'/api/products/' + ${product.id} + '/image'}" class="add-to-cart-btn bg-[#F56401] text-white py-2 px-4 rounded-lg hover:bg-orange-600 w-full transition duration-300 ease-in-out">Add to Cart</button>
                            </div>
                            <div th:if="${product.quantity == 0}" class="mt-auto">
                                <button class="bg-gray-400 text-white py-2 px-4 rounded-lg w-full cursor-not-allowed" disabled>Out of Stock</button>
                            </div>
                        </div>
                    </div>
                    <div th:if="${products == null || products.isEmpty()}" id="initialNoProductsMessage" class="text-center text-gray-500 py-10">
                        <p>No products available at the moment.</p>
                    </div>
                </div>
            </section>
            <script th:inline="javascript">
            /*<![CDATA[*/
                document.addEventListener('DOMContentLoaded', function() {
                    // Add to Cart
                    const cartButtons = document.querySelectorAll('.add-to-cart-btn');
                    cartButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const item = {
                                id: this.dataset.productId,
                                name: this.dataset.productName,
                                price: parseFloat(this.dataset.productPrice),
                                imageUrl: this.dataset.productImageUrl,
                                quantity: 1,
                                originalStock: parseInt(this.dataset.productStock)
                            };
                            addItemToCart(item);
                        });
                    });
                    // Filtering
                    const searchInput = document.getElementById('searchInput');
                    const categoryButtons = document.querySelectorAll('.category-btn');
                    const productCards = document.querySelectorAll('.product-card');
                    function filterProducts() {
                        const search = searchInput.value.toLowerCase();
                        const activeCategory = document.querySelector('.category-btn.bg-[#F56401]')?.dataset.category || 'All';
                        productCards.forEach(card => {
                            const name = card.getAttribute('data-name').toLowerCase();
                            const category = card.getAttribute('data-category');
                            const matchesCategory = activeCategory === 'All' || category === activeCategory;
                            const matchesSearch = name.includes(search);
                            card.style.display = (matchesCategory && matchesSearch) ? '' : 'none';
                        });
                    }
                    searchInput.addEventListener('input', filterProducts);
                    categoryButtons.forEach(btn => {
                        btn.addEventListener('click', function() {
                            categoryButtons.forEach(b => b.classList.remove('bg-[#F56401]', 'text-white'));
                            this.classList.add('bg-[#F56401]', 'text-white');
                            filterProducts();
                        });
                    });
                });
            /*]]>*/
            </script>
        </th:block>
    </main>
    <div th:replace="~{layout/main-layout :: footer}"></div>
</body>
</html>
