<!-- Checkout Page Template for Espressionist E-Commerce -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>espressionist | Checkout</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-beige min-h-screen flex flex-col justify-between">
    <!-- Navbar -->
    <nav class="flex items-center justify-between px-6 py-4 bg-white shadow-md">
        <div class="flex items-center space-x-2">
            <span class="font-seagull text-2xl text-white bg-[#F56401] px-3 py-1 rounded">espressionist</span>
        </div>
        <div class="flex items-center space-x-6">
            <a th:href="@{/products}" class="text-[#F56401] font-semibold hover:underline">Products</a>
            <a th:href="@{/cart}" class="text-[#F56401] font-semibold hover:underline">Cart</a>
            <a th:href="@{/order-status}" class="text-[#F56401] font-semibold hover:underline">Order Status</a>
            <a th:href="@{/admin/login}" class="text-[#F56401] font-semibold hover:underline">Admin</a>
        </div>
    </nav>

    <!-- Checkout Content -->
    <main class="flex-1 container mx-auto px-4 py-12 max-w-2xl">
        <h1 class="text-3xl font-seagull text-[#F56401] mb-8 text-center">Checkout</h1>
        <form id="checkout-form" class="bg-white rounded-lg shadow p-6 flex flex-col gap-4" autocomplete="off">
            <div>
                <label for="name" class="block font-bold mb-1">Full Name</label>
                <input type="text" id="name" name="name" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#F56401]"/>
            </div>
            <div>
                <label for="email" class="block font-bold mb-1">Email</label>
                <input type="email" id="email" name="email" required class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#F56401]"/>
            </div>
            <div>
                <label for="address" class="block font-bold mb-1">Shipping Address</label>
                <textarea id="address" name="address" required rows="2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#F56401]"></textarea>
            </div>
            <div class="mt-4">
                <h2 class="font-bold mb-2">Order Summary</h2>
                <div id="order-summary" class="text-sm"></div>
                <div class="font-bold mt-2">Total (with 12% VAT): <span id="order-total">₱0.00</span></div>
            </div>
            <div class="mt-4">
                <label class="block font-bold mb-1">Payment Method</label>
                <div class="flex items-center gap-2">
                    <input type="radio" id="cod" name="payment" value="cod" checked disabled class="accent-[#F56401]"/>
                    <label for="cod">Cash on Delivery</label>
                </div>
            </div>
            <button type="submit" id="place-order-btn" class="bg-[#F56401] text-white font-bold py-3 px-8 rounded shadow hover:bg-[#d35400] transition mt-4 flex items-center justify-center gap-2">
                <span>Place Order</span>
                <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
            </button>
            <div id="checkout-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </form>
    </main>

    <!-- Footer -->
    <footer class="bg-[#F56401] text-white py-6 mt-8">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center px-6">
            <div class="mb-4 md:mb-0">
                <span class="font-seagull text-xl">espressionist</span>
                <span class="ml-2">&copy; 2025</span>
            </div>
            <div class="flex space-x-4">
                <a href="mailto:info@espressionist.com" class="hover:underline">info@espressionist.com</a>
                <a href="#" class="hover:underline">Instagram</a>
                <a href="#" class="hover:underline">Facebook</a>
            </div>
        </div>
    </footer>

    <!-- Custom Fonts (Seagull Serial, Pruno Deck Medium) -->
    <style>
        @font-face {
            font-family: 'Seagull Serial';
            src: url('/fonts/SeagullSerial.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'Pruno Deck Medium';
            src: url('/fonts/PrunoDeckMedium.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        .font-seagull { font-family: 'Seagull Serial', sans-serif; }
        .font-pruno { font-family: 'Pruno Deck Medium', sans-serif; }
        .bg-beige { background-color: #f5f5dc; }
    </style>
    <script>
        // Utility: Format price
        function formatPrice(price) {
            return '₱' + price.toFixed(2);
        }
        // Fetch product data for cart items
        async function fetchProductData(productId) {
            const res = await fetch(`/products`);
            const products = await res.json();
            return products.find(p => p.id == productId);
        }
        // Render order summary
        async function renderOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('cart') || '{}');
            const summaryDiv = document.getElementById('order-summary');
            summaryDiv.innerHTML = '';
            let total = 0;
            let summaryHtml = '';
            for (const [productId, quantity] of Object.entries(cart)) {
                const product = await fetchProductData(productId);
                if (!product) continue;
                const subtotal = product.price * quantity;
                total += subtotal;
                summaryHtml += `<div class="flex justify-between mb-1"><span>${product.name} x <span class="font-bold">${quantity}</span></span><span>${formatPrice(subtotal)}</span></div>`;
            }
            summaryDiv.innerHTML = summaryHtml || '<span class="text-gray-500">No items in cart.</span>';
            const totalWithVAT = total * 1.12;
            document.getElementById('order-total').textContent = formatPrice(totalWithVAT);
            return { total, totalWithVAT };
        }
        // Handle checkout form submission
        document.addEventListener('DOMContentLoaded', function() {
            renderOrderSummary();
            document.getElementById('checkout-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                document.getElementById('checkout-error').classList.add('hidden');
                const spinner = document.getElementById('loading-spinner');
                spinner.classList.remove('hidden');
                const name = document.getElementById('name').value.trim();
                const email = document.getElementById('email').value.trim();
                const address = document.getElementById('address').value.trim();
                const cart = JSON.parse(localStorage.getItem('cart') || '{}');
                if (!name || !email || !address || Object.keys(cart).length === 0) {
                    document.getElementById('checkout-error').textContent = 'Please fill out all fields and ensure your cart is not empty.';
                    document.getElementById('checkout-error').classList.remove('hidden');
                    spinner.classList.add('hidden');
                    return;
                }
                // Prepare order data
                const items = [];
                for (const [productId, quantity] of Object.entries(cart)) {
                    items.push({ product: { id: productId }, quantity: quantity });
                }
                const orderData = {
                    customerName: name,
                    customerEmail: email,
                    shippingAddress: address,
                    orderItems: items
                };
                try {
                    const res = await fetch('/orders/checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderData)
                    });
                    if (res.ok) {
                        localStorage.removeItem('cart');
                        window.location.href = '/order-success';
                    } else {
                        const err = await res.json();
                        document.getElementById('checkout-error').textContent = err.message || 'Checkout failed. Please try again.';
                        document.getElementById('checkout-error').classList.remove('hidden');
                    }
                } catch (error) {
                    document.getElementById('checkout-error').textContent = 'Checkout failed. Please try again.';
                    document.getElementById('checkout-error').classList.remove('hidden');
                } finally {
                    spinner.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
