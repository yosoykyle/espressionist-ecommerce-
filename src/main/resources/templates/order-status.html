<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle='Track Your Order'">
<body>

    <div th:replace="~{layout/main-layout :: content}">
        <th:block>
            <section class="py-12 bg-[#F5F5DC]">
                <div class="container mx-auto px-4">
                    <h1 class="text-4xl font-bold text-center mb-10 text-gray-800">Track Your Order</h1>

                    <!-- Order Code Input Form -->
                    <form id="orderStatusForm" class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-xl mb-12">
                        <label for="orderCodeInput" class="block text-sm font-medium text-gray-700 mb-2">Enter Your Order Code:</label>
                        <div class="flex space-x-3">
                            <input type="text" id="orderCodeInput" name="orderCode"
                                   class="flex-grow w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-[#F56401] focus:border-[#F56401]"
                                   placeholder="e.g., ESP-XXXXXXX" required>
                            <button type="submit" id="trackOrderBtnForm"
                                    class="bg-[#F56401] text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 ease-in-out">
                                Track
                            </button>
                        </div>
                        <p id="formErrorMessage" class="text-red-500 text-xs mt-2"></p>
                    </form>

                    <!-- Loading Indicator -->
                    <div id="loadingIndicatorOrderStatus" class="my-10 text-center" style="display: none;">
                        <svg class="animate-spin h-8 w-8 text-[#F56401] mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-lg text-gray-600">Fetching order status...</p>
                    </div>
                    
                    <!-- API Error Message Area -->
                    <div id="apiErrorMessage" class="my-10 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg max-w-lg mx-auto text-center" style="display: none;">
                        <p id="apiErrorMessageText">Could not retrieve order details.</p>
                    </div>

                    <!-- Order Details Display Area -->
                    <div id="orderDetailsDisplayArea" class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto" style="display: none;">
                        <h2 class="text-2xl font-semibold mb-6 text-gray-700 text-center">Order Status</h2>
                        
                        <div class="mb-4">
                            <strong class="font-medium text-gray-600">Order Code:</strong>
                            <span id="displayOrderCode" class="text-gray-800 font-mono ml-2">N/A</span>
                        </div>
                        <div class="mb-4">
                            <strong class="font-medium text-gray-600">Order Date:</strong>
                            <span id="displayOrderDate" class="text-gray-800 ml-2">N/A</span>
                        </div>
                        <div class="mb-6 p-3 rounded-lg text-center" id="statusBadge">
                            <strong class="font-medium text-gray-600">Status:</strong>
                            <span id="displayOrderStatus" class="text-lg font-semibold ml-2">N/A</span>
                        </div>

                        <hr class="my-6">

                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Shipping Information</h3>
                        <div class="text-sm space-y-1 mb-6">
                            <p><strong class="font-medium text-gray-600">Name:</strong> <span id="displayCustomerName" class="text-gray-800">N/A</span></p>
                            <p><strong class="font-medium text-gray-600">Email:</strong> <span id="displayCustomerEmail" class="text-gray-800">N/A</span></p>
                            <p><strong class="font-medium text-gray-600">Address:</strong> <span id="displayShippingAddress" class="text-gray-800">N/A</span></p>
                        </div>

                        <hr class="my-6">

                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Items Ordered</h3>
                        <div id="displayOrderItems" class="space-y-2 text-sm max-h-60 overflow-y-auto border rounded-md p-3 bg-gray-50">
                            <!-- Items will be rendered here -->
                            <p class="text-gray-500">No items found.</p>
                        </div>
                        
                        <div id="displayOrderTotalContainer" class="text-right mt-4" style="display: none;">
                             <strong class="font-medium text-gray-600">Total Paid:</strong>
                             <span id="displayOrderTotal" class="text-lg text-gray-800 font-semibold ml-2">N/A</span>
                        </div>

                    </div>
                </div>
            </section>

            <script th:inline="javascript">
            /*<![CDATA[*/
                document.addEventListener('DOMContentLoaded', function() {
                    const orderStatusForm = document.getElementById('orderStatusForm');
                    const orderCodeInput = document.getElementById('orderCodeInput');
                    const formErrorMessage = document.getElementById('formErrorMessage');
                    
                    const loadingIndicator = document.getElementById('loadingIndicatorOrderStatus');
                    const apiErrorMessage = document.getElementById('apiErrorMessage');
                    const apiErrorMessageText = document.getElementById('apiErrorMessageText');
                    const orderDetailsDisplayArea = document.getElementById('orderDetailsDisplayArea');

                    // Display elements
                    const displayOrderCode = document.getElementById('displayOrderCode');
                    const displayOrderDate = document.getElementById('displayOrderDate');
                    const statusBadge = document.getElementById('statusBadge');
                    const displayOrderStatus = document.getElementById('displayOrderStatus');
                    const displayCustomerName = document.getElementById('displayCustomerName');
                    const displayCustomerEmail = document.getElementById('displayCustomerEmail');
                    const displayShippingAddress = document.getElementById('displayShippingAddress');
                    const displayOrderItems = document.getElementById('displayOrderItems');
                    const displayOrderTotalContainer = document.getElementById('displayOrderTotalContainer');
                    const displayOrderTotal = document.getElementById('displayOrderTotal');

                    function getStatusColorClasses(status) {
                        status = status ? status.toLowerCase() : '';
                        switch (status) {
                            case 'pending': return 'bg-yellow-100 text-yellow-700';
                            case 'processing': return 'bg-blue-100 text-blue-700';
                            case 'shipped': return 'bg-indigo-100 text-indigo-700';
                            case 'delivered': return 'bg-green-100 text-green-700';
                            case 'cancelled': return 'bg-red-100 text-red-700';
                            default: return 'bg-gray-100 text-gray-700';
                        }
                    }

                    function renderOrderStatusDetails(order) {
                        displayOrderCode.textContent = order.orderCode || 'N/A';
                        displayOrderDate.textContent = order.orderDate ? new Date(order.orderDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
                        
                        const status = order.status || 'N/A';
                        displayOrderStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                        statusBadge.className = 'mb-6 p-3 rounded-lg text-center ' + getStatusColorClasses(status);

                        // Assuming shippingInfo is an object or directly accessible fields
                        const shippingInfo = order.shippingInfo || order; // Adapt if structure is different
                        displayCustomerName.textContent = shippingInfo.customerName || shippingInfo.name || 'N/A';
                        displayCustomerEmail.textContent = shippingInfo.customerEmail || shippingInfo.email || 'N/A';
                        displayShippingAddress.textContent = shippingInfo.shippingAddress || shippingInfo.address || 'N/A';

                        displayOrderItems.innerHTML = ''; // Clear previous items
                        if (order.items && order.items.length > 0) {
                            order.items.forEach(item => {
                                const itemEl = document.createElement('div');
                                itemEl.className = 'py-1.5 flex justify-between items-center border-b border-gray-200 last:border-b-0';
                                const itemName = item.product ? item.product.name : (item.name || 'Unknown Product');
                                const itemPrice = item.price || 0;
                                const itemQuantity = item.quantity || 0;
                                itemEl.innerHTML = `
                                    <span class="flex-grow text-gray-700">${itemName} (x${itemQuantity})</span>
                                    <span class="text-gray-600 w-20 text-right">$${(itemPrice * itemQuantity).toFixed(2)}</span>
                                `;
                                displayOrderItems.appendChild(itemEl);
                            });
                        } else {
                            displayOrderItems.innerHTML = '<p class="text-gray-500">No items found for this order.</p>';
                        }
                        
                        if (order.totalWithVAT != null) {
                            displayOrderTotal.textContent = '$' + order.totalWithVAT.toFixed(2);
                            displayOrderTotalContainer.style.display = 'block';
                        } else {
                            displayOrderTotalContainer.style.display = 'none';
                        }

                        orderDetailsDisplayArea.style.display = 'block';
                    }

                    function fetchOrderStatus(code) {
                        if (!code) {
                            formErrorMessage.textContent = 'Please enter an order code.';
                            orderCodeInput.focus();
                            return;
                        }
                        formErrorMessage.textContent = '';
                        loadingIndicator.style.display = 'block';
                        apiErrorMessage.style.display = 'none';
                        orderDetailsDisplayArea.style.display = 'none';

                        // Update URL without reloading
                        const url = new URL(window.location);
                        url.searchParams.set('orderCode', code);
                        history.pushState({}, '', url);

                        fetch(`/api/order-status/${code}`)
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(errData => {
                                        throw new Error(errData.message || `Order not found or error fetching status (${response.status})`);
                                    }).catch(() => { // If .json() fails or no message
                                        throw new Error(`Order not found or error fetching status (${response.status} ${response.statusText})`);
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                loadingIndicator.style.display = 'none';
                                // Assuming backend sends 'orderItems' if 'items' is not present (like in order-success)
                                if (data.orderItems && !data.items) {
                                    data.items = data.orderItems;
                                }
                                renderOrderStatusDetails(data);
                            })
                            .catch(error => {
                                console.error('Error fetching order status:', error);
                                loadingIndicator.style.display = 'none';
                                apiErrorMessageText.textContent = error.message || 'An unexpected error occurred.';
                                apiErrorMessage.style.display = 'block';
                            });
                    }

                    orderStatusForm.addEventListener('submit', function(event) {
                        event.preventDefault();
                        const code = orderCodeInput.value.trim();
                        fetchOrderStatus(code);
                    });

                    // Check URL for orderCode on page load
                    const params = new URLSearchParams(window.location.search);
                    const urlOrderCode = params.get('orderCode');
                    if (urlOrderCode) {
                        orderCodeInput.value = urlOrderCode;
                        fetchOrderStatus(urlOrderCode);
                    }
                });
            /*]]>*/
            </script>
        </th:block>
    </div>

</body>
</html>
