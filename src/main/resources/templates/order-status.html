<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/base :: head">
    <title>espressionist - Track Order</title>
</head>
<body class="min-h-screen flex flex-col bg-white">
    <div th:replace="layout/base :: nav"></div>
    
    <main class="flex-grow">
        <!-- Order Status Header -->
        <section class="bg-primary text-white py-12 -mt-8">
            <div class="container mx-auto text-center">
                <h1 class="brand-font text-4xl mb-4">Track Your Order</h1>
                <p class="tagline-font text-xl">Check your order status</p>
            </div>
        </section>

        <section class="py-12">
            <div class="max-w-2xl mx-auto px-4">
                <!-- Order Code Input Form -->
                <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
                    <form id="trackForm" class="space-y-4">
                        <div>
                            <label for="orderCode" class="block text-sm font-medium text-gray-700">
                                Enter your order code
                            </label>
                            <div class="mt-1 flex rounded-md shadow-sm">
                                <input type="text" 
                                       id="orderCode" 
                                       name="orderCode" 
                                       required
                                       placeholder="e.g., ESP-3A9KZT1D"
                                       class="flex-1 min-w-0 block w-full px-3 py-2 rounded-md border-gray-300 focus:ring-primary focus:border-primary">
                                <button type="submit" 
                                        class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                                    Track Order
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Order Details (hidden by default) -->
                <div id="orderDetails" class="hidden bg-white shadow-lg rounded-lg overflow-hidden">
                    <div class="p-6">
                        <div class="border-b border-gray-200 pb-4 mb-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Order Code</h3>
                                    <p id="displayOrderCode" class="mt-1 font-mono"></p>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Order Date</h3>
                                    <p id="orderDate" class="mt-1"></p>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h3 class="text-sm font-medium text-gray-500">Status</h3>
                                <div id="orderStatus" class="mt-1"></div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-500">Shipping Information</h3>
                            <p id="shippingInfo" class="mt-1 whitespace-pre-line"></p>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-500 mb-4">Order Items</h3>
                            <div id="orderItems" class="space-y-4">
                                <!-- Order items will be inserted here -->
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="subtotal"></span>
                            </div>
                            <div class="flex justify-between mt-2">
                                <span class="text-gray-600">VAT (12%)</span>
                                <span id="vat"></span>
                            </div>
                            <div class="flex justify-between mt-2 text-lg font-semibold">
                                <span>Total</span>
                                <span id="total"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Error Message (hidden by default) -->
                <div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                Order not found. Please check your order code and try again.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div th:replace="layout/base :: footer"></div>

    <script>
        function formatPrice(price) {
            return 'â‚±' + price.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'processing':
                    return 'bg-blue-100 text-blue-800';
                case 'shipped':
                    return 'bg-purple-100 text-purple-800';
                case 'delivered':
                    return 'bg-green-100 text-green-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        document.getElementById('trackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderCode = document.getElementById('orderCode').value;
            const orderDetails = document.getElementById('orderDetails');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                const response = await fetch(`/api/orders/order-status/${orderCode}`);
                if (!response.ok) {
                    throw new Error('Order not found');
                }
                
                const order = await response.json();
                
                // Update order details
                document.getElementById('displayOrderCode').textContent = order.orderCode;
                document.getElementById('orderDate').textContent = new Date(order.orderDate).toLocaleDateString();
                document.getElementById('orderStatus').innerHTML = `
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium ${getStatusClass(order.status)}">
                        ${order.status}
                    </span>
                `;
                document.getElementById('shippingInfo').textContent = order.shippingInfo;
                
                // Update order items
                const orderItems = document.getElementById('orderItems');
                orderItems.innerHTML = '';
                
                let subtotal = 0;
                order.items.forEach(item => {
                    const itemSubtotal = item.price * item.quantity;
                    subtotal += itemSubtotal;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center';
                    itemElement.innerHTML = `
                        <img src="/api/products/image/${item.productId}" alt="${item.name}" class="w-16 h-16 object-cover rounded">
                        <div class="ml-4 flex-grow">
                            <div class="font-medium">${item.name}</div>
                            <div class="text-sm text-gray-500">Quantity: ${item.quantity}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${formatPrice(itemSubtotal)}</div>
                        </div>
                    `;
                    orderItems.appendChild(itemElement);
                });
                
                const vat = subtotal * 0.12;
                const total = subtotal + vat;
                
                document.getElementById('subtotal').textContent = formatPrice(subtotal);
                document.getElementById('vat').textContent = formatPrice(vat);
                document.getElementById('total').textContent = formatPrice(total);
                
                // Show order details and hide error
                orderDetails.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            } catch (error) {
                // Show error and hide order details
                orderDetails.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
