<!-- /*
    admin/orders.html
    Admin page for managing customer orders.
    Displays a list of orders and allows admins to update order statuses or archive orders.
    Uses admin-layout.html as its base.
    Data for 'orders' is provided by the backend model.
*/ -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle='Manage Orders'"> <!-- /* Sets the page title for the admin layout. */ -->
<body>

    <!-- /* Injects content into the 'content' placeholder of admin-layout.html. */ -->
    <div th:replace="~{admin/layout/admin-layout :: content}">
        <th:block>
            <!-- /* Main page heading. */ -->
            <h1 class="text-3xl font-bold text-gray-800 mb-8" th:text="${pageTitle}">Manage Orders</h1>

            <!-- /* Container for the orders table, styled as a white card with shadow. 'overflow-x-auto' for responsiveness. */ -->
            <div class="bg-white shadow-xl rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Order Code</th>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Customer</th>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Order Date</th>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total</th>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Shipping Address</th>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-5 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- /* Conditional row displayed if the 'orders' list is null or empty. */ -->
                        <tr th:if="${orders == null || orders.isEmpty()}">
                            <td colspan="7" class="px-5 py-10 whitespace-nowrap text-sm text-gray-500 text-center">
                                <div class="flex flex-col items-center">
                                     <!-- /* SVG icon indicating emptiness. */ -->
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                                    </svg>
                                    No orders found.
                                </div>
                            </td>
                        </tr>
                        <!-- /* Thymeleaf loop to iterate over each 'order' in the list. */ -->
                        <tr th:each="order : ${orders}" class="hover:bg-gray-50 transition-colors">
                            <!-- Order Code -->
                            <td class="px-5 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" th:text="${order.orderCode}">ESP-CODE-001</div>
                            </td>
                            <!-- Customer Name and Email -->
                            <td class="px-5 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900" th:text="${order.customerName}">John Doe</div>
                                <div class="text-xs text-gray-500" th:text="${order.customerEmail}">john.doe@example.com</div>
                            </td>
                            <!-- Order Date (formatted) -->
                            <td class="px-5 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700" th:text="${#temporals.format(order.orderDate, 'MMM dd, yyyy HH:mm')}">Jan 01, 2024 10:00</div>
                            </td>
                            <!-- Order Total -->
                            <td class="px-5 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-800" th:text="'$' + ${#numbers.formatDecimal(order.totalWithVAT, 1, 'COMMA', 2, 'POINT')}">$0.00</div>
                            </td>
                            <!-- Shipping Address (truncated, full address on hover) -->
                            <td class="px-5 py-4 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" th:title="${order.shippingAddress}">
                                <span th:text="${order.shippingAddress}">123 Main St, Anytown, USA</span>
                            </td>
                            <!-- Order Status (displayed as a styled badge) -->
                            <td class="px-5 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                      th:text="${order.status.toString().replace('_', ' ')}" /* Replaces underscores for display */
                                      th:classappend="${ /* Dynamically sets badge color based on status enum */
                                        order.status == T(com.espressionist_ecommerce.model.OrderStatus).PENDING ? 'bg-yellow-100 text-yellow-800' :
                                        order.status == T(com.espressionist_ecommerce.model.OrderStatus).PROCESSING ? 'bg-blue-100 text-blue-800' :
                                        order.status == T(com.espressionist_ecommerce.model.OrderStatus).SHIPPED ? 'bg-indigo-100 text-indigo-800' :
                                        order.status == T(com.espressionist_ecommerce.model.OrderStatus).DELIVERED ? 'bg-green-100 text-green-800' :
                                        order.status == T(com.espressionist_ecommerce.model.OrderStatus).CANCELLED ? 'bg-red-100 text-red-800' :
                                        order.status == T(com.espressionist_ecommerce.model.OrderStatus).ARCHIVED ? 'bg-gray-200 text-gray-700' : 'bg-gray-100 text-gray-800'
                                      }">
                                    Status
                                </span>
                            </td>
                            <!-- Actions Column (Update Status Dropdown or Archive Button) -->
                            <td class="px-5 py-4 whitespace-nowrap text-sm font-medium">
                                <!-- /* 
                                    Status Update Dropdown: Shown if order is not Delivered, Archived, or Cancelled.
                                    'data-order-id' and 'data-order-code' are used by JavaScript.
                                */ -->
                                <div th:if="${order.status != T(com.espressionist_ecommerce.model.OrderStatus).DELIVERED && order.status != T(com.espressionist_ecommerce.model.OrderStatus).ARCHIVED && order.status != T(com.espressionist_ecommerce.model.OrderStatus).CANCELLED}" class="inline-block relative">
                                    <select class="status-update-dropdown block appearance-none w-full bg-white border border-gray-300 hover:border-gray-400 px-3 py-2 pr-8 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                                            th:attr="data-order-id=${order.id}, data-order-code=${order.orderCode}">
                                        <!-- /* Options for updating status. Current status is pre-selected. */ -->
                                        <option value="PENDING" th:selected="${order.status == T(com.espressionist_ecommerce.model.OrderStatus).PENDING}">Pending</option>
                                        <option value="PROCESSING" th:selected="${order.status == T(com.espressionist_ecommerce.model.OrderStatus).PROCESSING}">Processing</option>
                                        <option value="SHIPPED" th:selected="${order.status == T(com.espressionist_ecommerce.model.OrderStatus).SHIPPED}">Shipped</option>
                                        <option value="DELIVERED" th:selected="${order.status == T(com.espressionist_ecommerce.model.OrderStatus).DELIVERED}">Delivered</option>
                                    </select>
                                     <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                    </div>
                                </div>
                                <!-- /* 
                                    Archive Button: Shown if order status is DELIVERED.
                                    Uses JavaScript for confirmation and submission.
                                */ -->
                                <button th:if="${order.status == T(com.espressionist_ecommerce.model.OrderStatus).DELIVERED}"
                                        class="archive-order-btn text-sm bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-md shadow-sm transition duration-150 ease-in-out"
                                        th:attr="data-order-id=${order.id}, data-order-code=${order.orderCode}">
                                    Archive
                                </button>
                                <!-- /* "No actions" text for Archived or Cancelled orders. */ -->
                                <span th:if="${order.status == T(com.espressionist_ecommerce.model.OrderStatus).ARCHIVED || order.status == T(com.espressionist_ecommerce.model.OrderStatus).CANCELLED}" class="text-xs text-gray-500 italic">
                                    No actions
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- /* Inline JavaScript for handling status updates and archiving orders. */ -->
            <script th:inline="javascript">
            /*<![CDATA[*/
                document.addEventListener('DOMContentLoaded', function () {
                    // --- Status Update Dropdown Logic ---
                    const statusDropdowns = document.querySelectorAll('.status-update-dropdown');
                    statusDropdowns.forEach(dropdown => {
                        dropdown.addEventListener('change', function () {
                            const orderId = this.dataset.orderId;
                            const orderCode = this.dataset.orderCode; // Used for display in the confirmation modal
                            const newStatus = this.value;
                            const currentStatusText = this.options[this.selectedIndex].text; // User-friendly status text
                            
                            // Confirm the status change using the custom modal from ui.js
                            showModal(
                                'Confirm Status Update',
                                `Are you sure you want to update order ${orderCode} to "${currentStatusText}"?`,
                                function() { // onConfirm callback: executed if user confirms
                                    dropdown.disabled = true; // Disable dropdown during the API call
                                    
                                    // API call to update order status
                                    fetch(`/admin/orders/${orderId}/status`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            // 'X-CSRF-TOKEN': ... // Add CSRF token if Spring Security CSRF is enabled
                                        },
                                        body: JSON.stringify({ status: newStatus }) // Send new status in request body
                                    })
                                    .then(response => {
                                        // Handle non-OK responses using the standardized error pattern
                                        if (!response.ok) {
                                            return response.json()
                                                .then(errorData => {
                                                    throw new Error(errorData.message || `Server error: ${response.status} ${response.statusText || 'Failed to update status'}`.trim());
                                                })
                                                .catch(() => {
                                                    throw new Error(`Request failed: ${response.status} ${response.statusText || 'Failed to update status'}`.trim());
                                                });
                                        }
                                        return response.json(); // Expecting JSON response on success (e.g., updated order or success message)
                                    })
                                    .then(data => {
                                        showToast(`Order ${orderCode} status updated to ${newStatus}!`, 'success'); // Show success toast
                                        setTimeout(() => window.location.reload(), 1000); // Reload page to reflect changes
                                    })
                                    .catch(error => {
                                        console.error('Status update error:', error);
                                        showToast(error.message || 'An unexpected error occurred. Please try again.', 'error'); // Show error toast
                                        dropdown.disabled = false; // Re-enable dropdown on error
                                        // Note: Dropdown will retain the user's new (unconfirmed) selection. Page reload will fix it to actual status.
                                    });
                                }
                                // onCancel callback (optional): If user cancels, no action is taken. Dropdown remains on new selection.
                            );
                        });
                    });

                    // --- Archive Order Button Logic ---
                    const archiveButtons = document.querySelectorAll('.archive-order-btn');
                    archiveButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            const orderId = this.dataset.orderId;
                            const orderCode = this.dataset.orderCode; // Used for display in modal

                            // Confirm the archive action
                            showModal(
                                'Confirm Archive Order',
                                `Are you sure you want to archive order ${orderCode}? This action may not be easily reversible.`,
                                function() { // onConfirm callback
                                    // Update button state to indicate processing
                                    button.disabled = true;
                                    button.innerHTML = 'Archiving... <svg class="animate-spin inline h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

                                    // API call to archive the order
                                    fetch(`/admin/orders/${orderId}/archive`, {
                                        method: 'POST',
                                        headers: {
                                            // 'X-CSRF-TOKEN': ... // Add CSRF token if needed
                                        }
                                    })
                                    .then(response => {
                                        // Handle non-OK responses
                                        if (!response.ok) {
                                             return response.json()
                                                .then(errorData => {
                                                    throw new Error(errorData.message || `Server error: ${response.status} ${response.statusText || 'Failed to archive'}`.trim());
                                                })
                                                .catch(() => {
                                                    throw new Error(`Request failed: ${response.status} ${response.statusText || 'Failed to archive'}`.trim());
                                                });
                                        }
                                        // Handle successful responses (e.g., 200 OK or 204 No Content)
                                        if (response.status === 200 || response.status === 204 || (response.headers.get("content-length") === "0" && response.ok) ) {
                                           return null; // Success, no content to parse
                                        }
                                        return response.json(); // If JSON response is expected on success
                                    })
                                    .then(data => { // data might be null here
                                        showToast(`Order ${orderCode} archived successfully!`, 'success');
                                        setTimeout(() => window.location.reload(), 1000); // Reload to reflect change
                                    })
                                    .catch(error => {
                                        console.error('Archive error:', error);
                                        showToast(error.message || 'An unexpected error occurred. Please try again.', 'error');
                                        // Reset button state on error
                                        button.disabled = false;
                                        button.textContent = 'Archive';
                                    });
                                }
                                // onCancel callback (optional): If user cancels, button remains enabled.
                            );
                        });
                    });
                });
            /*]]>*/
            </script>
        </th:block>
    </div>

</body>
</html>
