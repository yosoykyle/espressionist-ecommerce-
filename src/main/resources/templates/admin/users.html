<!-- /*
    admin/users.html
    Admin page for managing admin users (listing, adding, editing, deleting).
    Uses admin-layout.html as its base.
    Data for 'admins' (list of admin users) is provided by the backend model.
    'isCurrentUser' boolean flag on each adminUser object is crucial for self-deletion prevention.
*/ -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:with="pageTitle='Manage Admin Users'">
<body>
    <div th:replace="~{admin/layout/admin-layout :: header}"></div>
    <main th:replace="~{admin/layout/admin-layout :: content}">
        <th:block>
            <!-- /* Page header with title and "Add New Admin" button. */ -->
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800" th:text="${pageTitle}">Manage Admin Users</h1>
                <!-- /* Button to navigate to the new admin user form page. */ -->
                <a th:href="@{/admin/users/new}"
                   class="bg-[#F56401] text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 ease-in-out">
                    Add New Admin
                </a>
            </div>

            <!-- /* Container for the admin users table. Styled as a white card with shadow. */ -->
            <div class="bg-white shadow-xl rounded-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" aria-label="Admin User List">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Roles</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- /* Conditional row: Displayed if the 'admins' list is null or empty. */ -->
                        <tr th:if="${admins == null || admins.isEmpty()}">
                            <td colspan="5" class="px-6 py-10 whitespace-nowrap text-sm text-gray-500 text-center">
                                <div class="flex flex-col items-center">
                                     <!-- /* SVG icon indicating emptiness. */ -->
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    No admin users found.
                                </div>
                            </td>
                        </tr>
                        <!-- /* Thymeleaf loop to iterate over each 'adminUser' in the 'admins' list. */ -->
                        <tr th:each="adminUser : ${admins}" class="hover:bg-gray-50 transition-colors">
                            <!-- Username Cell -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900" th:text="${adminUser.username}">admin_user</div>
                                <!-- /* "(You)" badge: Displayed if this adminUser is the currently logged-in user.
                                     'adminUser.isCurrentUser' is a boolean flag expected from the backend model. */ -->
                                <span th:if="${adminUser.isCurrentUser}" class="ml-2 px-2 py-0.5 inline-flex text-xs leading-4 font-semibold rounded-full bg-green-100 text-green-800">
                                    You
                                </span>
                            </td>
                            <!-- Email Cell -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700" th:text="${adminUser.email}">user@example.com</div>
                            </td>
                            <!-- Name Cell (Displays 'N/A' if name is null) -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700" th:text="${adminUser.name != null ? adminUser.name : 'N/A'}">Admin Name</div>
                            </td>
                            <!-- Roles Cell (Currently hardcoded as "ADMIN") -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
                                    ADMIN
                                </span>
                                <!-- /* Placeholder comment for future multi-role support. */ -->
                                <!-- In future, this could be a loop for multiple roles -->
                            </td>
                            <!-- Actions Cell (Edit, Delete) -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">
                                <!-- /* Link to edit admin user page. */ -->
                                <a th:href="@{/admin/users/edit/{userId}(userId=${adminUser.id})}" class="text-indigo-600 hover:text-indigo-800 font-medium">Edit</a>
                                <!-- /* 
                                    Delete Button: Uses JavaScript for confirmation and submission.
                                    'data-delete-url' holds the endpoint for the delete action.
                                    'data-username' is used in the confirmation modal message.
                                    'th:disabled' and 'th:classappend' prevent self-deletion by disabling the button for the current user.
                                */ -->
                                <button type="button"
                                        class="delete-admin-btn text-red-600 hover:text-red-800 font-medium"
                                        th:attr="data-delete-url=@{/admin/users/delete/{userId}(userId=${adminUser.id})}, data-username=${adminUser.username}"
                                        th:disabled="${adminUser.isCurrentUser}"
                                        th:classappend="${adminUser.isCurrentUser ? 'opacity-50 cursor-not-allowed' : ''}">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- /* Inline JavaScript for handling the delete admin user functionality. */ -->
            <script th:inline="javascript">
            /*<![CDATA[*/
                document.addEventListener('DOMContentLoaded', function () {
                    // Select all buttons with the class 'delete-admin-btn'.
                    const deleteButtons = document.querySelectorAll('.delete-admin-btn');
                    
                    deleteButtons.forEach(button => {
                        button.addEventListener('click', function () {
                            // Prevent action if button is disabled (e.g., for current user).
                            if (this.disabled) return; 

                            const deleteUrl = this.dataset.deleteUrl; // Get delete URL from data attribute.
                            const username = this.dataset.username;   // Get username for confirmation message.
                            
                            // Use the custom modal (from ui.js) to confirm the delete action.
                            showModal(
                                'Confirm Delete Admin',
                                `Are you sure you want to delete admin user "${username}"? This action cannot be undone.`,
                                function() { // onConfirm callback: Executed if the user confirms.
                                    // Update button state to indicate processing.
                                    button.disabled = true;
                                    button.innerHTML = 'Deleting... <svg class="animate-spin inline h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                                    
                                    // Perform the delete action using a POST request via Fetch API.
                                    fetch(deleteUrl, {
                                        method: 'POST',
                                        headers: {
                                            // 'X-CSRF-TOKEN': ... // Add CSRF token if Spring Security CSRF is enabled.
                                        }
                                    })
                                    .then(response => {
                                        // Handle non-OK responses using the standardized error pattern.
                                        if (!response.ok) {
                                            return response.json() 
                                                .then(errorData => {
                                                    throw new Error(errorData.message || `Server error: ${response.status} ${response.statusText || 'Failed to delete'}`.trim());
                                                })
                                                .catch(() => { 
                                                    throw new Error(`Request failed: ${response.status} ${response.statusText || 'Failed to delete'}`.trim());
                                                });
                                        }
                                        // Handle successful responses (e.g., 200 OK or 204 No Content).
                                        if (response.status === 200 || response.status === 204 || (response.headers.get("content-length") === "0" && response.ok) ) {
                                           return null; // Success, no content to parse.
                                        }
                                        return response.json(); // Or response.text() if plain text success is expected.
                                    })
                                    .then(data => { // data might be null here if response was 204.
                                        showToast(`Admin user "${username}" deleted successfully!`, 'success'); // Show success toast.
                                        setTimeout(() => window.location.reload(), 1000); // Reload page to reflect changes.
                                    })
                                    .catch(error => {
                                        // Handle any errors from fetch or thrown exceptions.
                                        console.error('Delete admin error:', error);
                                        showToast(error.message || 'Error deleting admin user. Please try again.', 'error');
                                        // Reset button state on error.
                                        button.disabled = false; 
                                        button.textContent = 'Delete';
                                    });
                                }
                                // onCancel callback (optional): Button remains enabled by default if no action in onCancel.
                            );
                        });
                    });
                });
            /*]]>*/
            </script>
        </th:block>
    </main>
    <div th:replace="~{admin/layout/admin-layout :: footer}"></div>
</body>
</html>
