<!-- /*
    admin/product-form.html
    Admin form for creating a new product or editing an existing one.
    Uses admin-layout.html as its base.
    Handles file uploads for product images (`enctype="multipart/form-data"`).
    Client-side JavaScript provides image preview and basic form validation.
*/ -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle=${product.id == null ? 'Add New Product' : 'Edit Product - ' + product.name}">
      <!-- /* Dynamically sets page title based on whether creating or editing a product. */ -->
<body>

    <!-- /* Injects content into the 'content' placeholder of admin-layout.html. */ -->
    <div th:replace="~{admin/layout/admin-layout :: content}">
        <th:block>
            <h1 class="text-3xl font-bold text-gray-800 mb-8" th:text="${pageTitle}">Form Title</h1>

            <!-- /* Form container, styled as a white card. */ -->
            <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto">
                <!-- /* 
                    Form for product data.
                    'th:action' specifies the submission URL.
                    'th:object' binds the form to the 'product' model attribute from the backend.
                    'enctype="multipart/form-data"' is crucial for file uploads.
                */ -->
                <form id="productForm" th:action="@{/admin/products/save}" th:object="${product}" method="post" enctype="multipart/form-data" class="space-y-6">
                    
                    <!-- /* Hidden input for product ID; only included if editing an existing product (product.id is not null). */ -->
                    <input type="hidden" th:if="${product.id != null}" th:field="*{id}" />

                    <!-- Product Name Field -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="name" th:field="*{name}"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                               required> <!-- /* HTML5 required attribute for basic browser validation. */ -->
                        <p id="nameError" class="text-red-500 text-xs mt-1"></p> <!-- /* Placeholder for JS validation error. */ -->
                    </div>

                    <!-- Product Price Field -->
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                        <input type="number" id="price" th:field="*{price}" step="0.01" min="0.01" <!-- /* step and min for number input constraints. */ -->
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                               required>
                        <p id="priceError" class="text-red-500 text-xs mt-1"></p>
                    </div>

                    <!-- Product Quantity (Stock) Field -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity (Stock)</label>
                        <input type="number" id="quantity" th:field="*{quantity}" min="0"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                               required>
                        <p id="quantityError" class="text-red-500 text-xs mt-1"></p>
                    </div>

                    <!-- Product Category Dropdown -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="category" th:field="*{category}"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                                required>
                            <option value="">-- Select Category --</option>
                            <!-- /* 
                                Hardcoded category options. These values (e.g., 'COFFEE_AND_TEA') are expected to match
                                the string representation of the Product.Category enum on the backend.
                            */ -->
                            <option value="COFFEE_AND_TEA">Coffee & Tea</option>
                            <option value="ART_AND_MERCH">Art & Merch</option>
                            <option value="GIFT_SET">Gift Set</option>
                            <option value="VOUCHER">Voucher</option>
                        </select>
                        <p id="categoryError" class="text-red-500 text-xs mt-1"></p>
                    </div>
                    
                    <!-- Product Description Field -->
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="description" th:field="*{description}" rows="4"
                                  class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"></textarea>
                        <p id="descriptionError" class="text-red-500 text-xs mt-1"></p> <!-- /* Placeholder for optional description validation. */ -->
                    </div>


                    <!-- Product Image Upload Section -->
                    <div>
                        <label for="imageFile" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
                        <!-- /* 
                            File input for image upload. 'name="imageFile"' must match the MultipartFile parameter name in the controller.
                            'accept' attribute filters file types in the browser's file dialog.
                        */ -->
                        <input type="file" id="imageFile" name="imageFile" accept="image/png, image/jpeg, image/gif"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#F56401] file:text-white hover:file:bg-orange-600">
                        <p id="imageFileError" class="text-red-500 text-xs mt-1"></p> <!-- /* For JS validation errors related to the file. */ -->
                        
                        <!-- Image Preview Area -->
                        <div class="mt-4">
                            <p id="imagePreviewText" class="text-sm font-medium text-gray-700 mb-1"
                               th:text="${product.id != null && product.image != null ? 'Current Image Preview:' : 'Image Preview:'}">Image Preview:</p>
                            <!-- /* 
                                Image tag for preview. 
                                'th:src' displays current image if editing and image exists, otherwise a transparent placeholder.
                                'th:classappend' adds placeholder styling if no current image.
                                JavaScript will update this 'src' to show a preview of a newly selected file.
                            */ -->
                            <img id="imagePreview" 
                                 th:src="${product.id != null && product.image != null ? @{'/api/products/' + ${product.id} + '/image'} : 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}" 
                                 alt="Image Preview" 
                                 class="h-40 w-40 object-cover rounded-md shadow border"
                                 th:classappend="${product.id == null || product.image == null ? 'border-dashed border-gray-300 p-2 flex items-center justify-center text-gray-400 text-xs' : ''}"
                                 th:alt="${product.id == null || product.image == null ? 'No image selected or available' : 'Product Image Preview'}"/>
                        </div>
                         <!-- /* Helper text regarding image replacement or selection. */ -->
                         <p th:if="${product.id != null && product.image != null}" class="text-xs text-gray-500 mt-1">Uploading a new image will replace the current one.</p>
                         <p th:if="${product.id == null || product.image == null}" class="text-xs text-gray-500 mt-1">Select an image to preview.</p>
                    </div>

                    <!-- Action Buttons: Cancel and Save -->
                    <div class="flex items-center justify-end space-x-4 pt-4">
                        <!-- /* Cancel button navigates back to the product listing page. */ -->
                        <a th:href="@{/admin/products}"
                           class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 ease-in-out">
                            Cancel
                        </a>
                        <!-- /* Submit button for saving the product. */ -->
                        <button type="submit"
                                class="bg-[#F56401] text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 ease-in-out">
                            Save Product
                        </button>
                    </div>
                </form>
            </div>

            <!-- /* Inline JavaScript for client-side form validation and image preview. */ -->
            <script th:inline="javascript">
            /*<![CDATA[*/
                document.addEventListener('DOMContentLoaded', function () {
                    // DOM element references for form and inputs
                    const productForm = document.getElementById('productForm');
                    const nameInput = document.getElementById('name');
                    const priceInput = document.getElementById('price');
                    const quantityInput = document.getElementById('quantity');
                    const categoryInput = document.getElementById('category');
                    const imageFileInput = document.getElementById('imageFile');
                    const imagePreview = document.getElementById('imagePreview');
                    const imagePreviewText = document.getElementById('imagePreviewText'); // Text above the preview image
                    
                    // Determine if editing: 'originalImageSrc' gets current image URL from Thymeleaf if product exists and has image.
                    const originalImageSrc = /*[[${(product.id != null && product.image != null) ? @{'/api/products/' + product.id + '/image'} : null}]]*/ null;
                    const placeholderImageSrc = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // 1x1 transparent GIF

                    // Set initial state of the image preview
                    if (originalImageSrc) {
                        imagePreview.src = originalImageSrc; // Show current image
                    } else {
                        imagePreview.src = placeholderImageSrc; // Show placeholder
                        imagePreview.alt = 'No image selected or available';
                        imagePreview.classList.add('border-dashed', 'border-gray-300', 'p-2', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-xs');
                        imagePreviewText.textContent = 'Image Preview: (No current image)';
                    }

                    // Event listener for file input changes (image preview and validation)
                    imageFileInput.addEventListener('change', function(event) {
                        const file = event.target.files[0];
                        const imageFileError = document.getElementById('imageFileError');
                        imageFileError.textContent = ''; // Clear any previous file error

                        if (file) {
                            // Validate file type (client-side)
                            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                            if (!validTypes.includes(file.type)) {
                                showToast('Invalid file type. Please select a JPG, PNG, or GIF image.', 'error');
                                imageFileInput.value = ''; // Clear the invalid file from input
                                // Revert preview to original or placeholder
                                imagePreview.src = originalImageSrc || placeholderImageSrc;
                                imagePreview.alt = originalImageSrc ? 'Current Product Image' : 'No image selected or available';
                                imagePreviewText.textContent = originalImageSrc ? 'Current Image Preview:' : 'Image Preview: (No current image)';
                                if (!originalImageSrc) { // Re-apply placeholder styles if no original image
                                    imagePreview.classList.add('border-dashed', 'border-gray-300', 'p-2', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-xs');
                                } else { // Ensure placeholder styles are removed if there was an original image
                                     imagePreview.classList.remove('border-dashed', 'border-gray-300', 'p-2', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-xs');
                                }
                                return;
                            }

                            // Read and display preview of the selected valid image file
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                imagePreview.src = e.target.result;
                                imagePreview.alt = 'New image preview';
                                imagePreviewText.textContent = 'New Image Preview:';
                                // Remove placeholder styling if it was applied
                                imagePreview.classList.remove('border-dashed', 'border-gray-300', 'p-2', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-xs');
                            }
                            reader.readAsDataURL(file);
                        } else {
                            // No file selected (e.g., user cleared the file input) - revert preview
                            imagePreview.src = originalImageSrc || placeholderImageSrc;
                            imagePreview.alt = originalImageSrc ? 'Current Product Image' : 'No image selected or available';
                            imagePreviewText.textContent = originalImageSrc ? 'Current Image Preview:' : 'Image Preview: (No current image)';
                            if (!originalImageSrc) { // Re-apply placeholder styles if needed
                                imagePreview.classList.add('border-dashed', 'border-gray-300', 'p-2', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-xs');
                            } else {
                                imagePreview.classList.remove('border-dashed', 'border-gray-300', 'p-2', 'flex', 'items-center', 'justify-center', 'text-gray-400', 'text-xs');
                            }
                        }
                    });

                    // Event listener for form submission (client-side validation)
                    productForm.addEventListener('submit', function (event) {
                        let isValid = true;

                        // Clear previous validation errors shown in the form
                        document.querySelectorAll('.text-red-500.text-xs.mt-1').forEach(el => el.textContent = '');

                        // Name validation: must not be empty
                        if (nameInput.value.trim() === '') {
                            document.getElementById('nameError').textContent = 'Product name is required.';
                            isValid = false;
                        }

                        // Price validation: must be a number greater than 0
                        const priceValue = parseFloat(priceInput.value);
                        if (isNaN(priceValue) || priceValue <= 0) {
                            document.getElementById('priceError').textContent = 'Price must be a number greater than 0.';
                            isValid = false;
                        }
                        
                        // Quantity validation: must be a number greater than or equal to 0
                        const quantityValue = parseInt(quantityInput.value);
                        if (isNaN(quantityValue) || quantityValue < 0) {
                             document.getElementById('quantityError').textContent = 'Quantity must be a number greater than or equal to 0.';
                             isValid = false;
                        }

                        // Category validation: a category must be selected
                        if (categoryInput.value === '') {
                            document.getElementById('categoryError').textContent = 'Please select a category.';
                            isValid = false;
                        }
                        
                        // Example of more complex image validation (e.g., file size) - currently commented out.
                        // The 'accept' attribute on the file input provides basic browser-level type filtering.
                        // if (imageFileInput.files.length > 0) {
                        //    const file = imageFileInput.files[0];
                        //    if (file.size > 2 * 1024 * 1024) { // Max 2MB example
                        //        document.getElementById('imageFileError').textContent = 'Image file size should not exceed 2MB.';
                        //        isValid = false;
                        //    }
                        // }

                        // If any validation failed, prevent form submission and show a general toast.
                        if (!isValid) {
                            event.preventDefault(); 
                            showToast('Please correct the errors in the form.', 'error');
                        } else {
                            // If form is valid, update submit button to show loading state.
                            // Actual submission is handled by the browser as a standard form POST.
                            const submitButton = productForm.querySelector('button[type="submit"]');
                            submitButton.disabled = true;
                            submitButton.innerHTML = 'Saving... <svg class="animate-spin inline h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                        }
                    });
                });
            /*]]>*/
            </script>
        </th:block>
    </div>

</body>
</html>
