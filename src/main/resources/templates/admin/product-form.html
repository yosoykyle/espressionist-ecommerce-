<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:with="pageTitle=${product.id == null ? 'Add New Product' : 'Edit Product - ' + product.name}">
<body>

    <div th:replace="~{admin/layout/admin-layout :: content}">
        <th:block>
            <h1 class="text-3xl font-bold text-gray-800 mb-8" th:text="${pageTitle}">Form Title</h1>

            <div class="bg-white p-8 rounded-xl shadow-xl max-w-2xl mx-auto">
                <form id="productForm" th:action="@{/admin/products/save}" th:object="${product}" method="post" enctype="multipart/form-data" class="space-y-6">
                    
                    <!-- Hidden ID for existing products -->
                    <input type="hidden" th:if="${product.id != null}" th:field="*{id}" />

                    <!-- Product Name -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                        <input type="text" id="name" th:field="*{name}"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                               required>
                        <p id="nameError" class="text-red-500 text-xs mt-1"></p>
                    </div>

                    <!-- Product Price -->
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700 mb-1">Price ($)</label>
                        <input type="number" id="price" th:field="*{price}" step="0.01" min="0.01"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                               required>
                        <p id="priceError" class="text-red-500 text-xs mt-1"></p>
                    </div>

                    <!-- Product Quantity (Stock) -->
                    <div>
                        <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity (Stock)</label>
                        <input type="number" id="quantity" th:field="*{quantity}" min="0"
                               class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                               required>
                        <p id="quantityError" class="text-red-500 text-xs mt-1"></p>
                    </div>

                    <!-- Product Category -->
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="category" th:field="*{category}"
                                class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"
                                required>
                            <option value="">-- Select Category --</option>
                            <!-- Assuming Product.Category is an Enum that converts to these exact string values -->
                            <option value="COFFEE_AND_TEA">Coffee & Tea</option>
                            <option value="ART_AND_MERCH">Art & Merch</option>
                            <option value="GIFT_SET">Gift Set</option>
                            <option value="VOUCHER">Voucher</option>
                        </select>
                        <p id="categoryError" class="text-red-500 text-xs mt-1"></p>
                    </div>
                    
                    <!-- Product Description -->
                    <div>
                        <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="description" th:field="*{description}" rows="4"
                                  class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-[#F56401] focus:border-transparent"></textarea>
                        <p id="descriptionError" class="text-red-500 text-xs mt-1"></p> <!-- Optional validation -->
                    </div>


                    <!-- Product Image Upload -->
                    <div>
                        <label for="imageFile" class="block text-sm font-medium text-gray-700 mb-1">Product Image</label>
                        <input type="file" id="imageFile" name="imageFile" accept="image/png, image/jpeg, image/gif"
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-[#F56401] file:text-white hover:file:bg-orange-600">
                        <p class="text-xs text-gray-500 mt-1">Upload a new image. If editing, leaving this empty will keep the current image.</p>
                        <p id="imageFileError" class="text-red-500 text-xs mt-1"></p>
                         <!-- Display current image if editing and image exists -->
                        <div th:if="${product.id != null && product.image != null}" class="mt-4">
                             <p class="text-sm font-medium text-gray-700 mb-1">Current Image:</p>
                             <img th:src="@{'/api/products/' + ${product.id} + '/image'}" alt="Current Product Image" class="h-32 w-32 object-cover rounded-md shadow"/>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex items-center justify-end space-x-4 pt-4">
                        <a th:href="@{/admin/products}"
                           class="bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-gray-300 transition duration-300 ease-in-out">
                            Cancel
                        </a>
                        <button type="submit"
                                class="bg-[#F56401] text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 ease-in-out">
                            Save Product
                        </button>
                    </div>
                </form>
            </div>

            <script th:inline="javascript">
            /*<![CDATA[*/
                document.addEventListener('DOMContentLoaded', function () {
                    const productForm = document.getElementById('productForm');
                    const nameInput = document.getElementById('name');
                    const priceInput = document.getElementById('price');
                    const quantityInput = document.getElementById('quantity');
                    const categoryInput = document.getElementById('category');
                    const imageFileInput = document.getElementById('imageFile'); // For image validation if needed

                    productForm.addEventListener('submit', function (event) {
                        let isValid = true;

                        // Clear previous errors
                        document.querySelectorAll('.text-red-500.text-xs.mt-1').forEach(el => el.textContent = '');

                        // Name validation
                        if (nameInput.value.trim() === '') {
                            document.getElementById('nameError').textContent = 'Product name is required.';
                            isValid = false;
                        }

                        // Price validation
                        const priceValue = parseFloat(priceInput.value);
                        if (isNaN(priceValue) || priceValue <= 0) {
                            document.getElementById('priceError').textContent = 'Price must be a number greater than 0.';
                            isValid = false;
                        }
                        
                        // Quantity validation
                        const quantityValue = parseInt(quantityInput.value);
                        if (isNaN(quantityValue) || quantityValue < 0) {
                             document.getElementById('quantityError').textContent = 'Quantity must be a number greater than or equal to 0.';
                             isValid = false;
                        }

                        // Category validation
                        if (categoryInput.value === '') {
                            document.getElementById('categoryError').textContent = 'Please select a category.';
                            isValid = false;
                        }
                        
                        // Image file validation (optional - example: check file size or type beyond 'accept' attribute)
                        // For this task, 'accept' attribute is considered sufficient for basic type filtering.
                        // if (imageFileInput.files.length > 0) {
                        //    const file = imageFileInput.files[0];
                        //    if (file.size > 2 * 1024 * 1024) { // Max 2MB example
                        //        document.getElementById('imageFileError').textContent = 'Image file size should not exceed 2MB.';
                        //        isValid = false;
                        //    }
                        // }


                        if (!isValid) {
                            event.preventDefault(); // Prevent form submission
                            showToast('Please correct the errors in the form.', 'error');
                        } else {
                            // Optional: Show a loading indicator on submit button
                            const submitButton = productForm.querySelector('button[type="submit"]');
                            submitButton.disabled = true;
                            submitButton.innerHTML = 'Saving... <svg class="animate-spin inline h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                        }
                    });
                });
            /*]]>*/
            </script>
        </th:block>
    </div>

</body>
</html>
